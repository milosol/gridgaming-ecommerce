{% extends 'core/base.html' %}
{% load static %}
{% load mathfilters %}

{% block extra_head_tags %}
<!-- <link href="{% static 'taginput/stylesheets/inputTag.css' %}" rel="stylesheet"> -->
<link href="{% static 'taginput/jquery.tagsinput-revisited.css' %}" rel="stylesheet">
<!-- <link rel="stylesheet" href="http://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css"> -->

<style>
    @media (min-width: 576px){
        #verifyModal .modal-dialog {
            max-width: 70%!important;
            margin: 1.75rem auto;
        }
    }
    .switch {
      position: relative;
      display: inline-block;
      width: 40px;
      height: 22px;
    }
    
    .switch input { 
      opacity: 0;
      width: 0;
      height: 0;
    }
    
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      -webkit-transition: .4s;
      transition: .4s;
    }
    
    .slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 2px;
      bottom: 2px;
      background-color: white;
      -webkit-transition: .4s;
      transition: .4s;
    }
    
    input:checked + .slider {
      background-color: #2196F3;
    }
    
    input:focus + .slider {
      box-shadow: 0 0 1px #2196F3;
    }
    
    input:checked + .slider:before {
      -webkit-transform: translateX(18px);
      -ms-transform: translateX(18px);
      transform: translateX(18px);
    }
    
    /* Rounded sliders */
    .slider.round {
      border-radius: 18px;
      height: 22px;
      width: 40px;
    }
    
    .slider.round:before {
      border-radius: 50%;
    }
    .option-container{
        border-top: 2px solid #5a686c;
        border-spacing: 40px;
        display: block;
    }
    .option-label{
        width: fit-content;
        background-color: #272b34;
        font-weight: bold;
        font-size: 1rem;
        /* color: #0cc0f6; */
        text-shadow: 1px 1px 4px #5a686c;
        margin-top:-20px;
        margin-left: 40px;
        border-radius: 40%;
        border: 2px solid #5a686c;
    }
    #div_link label, #div_verify label{
        display: none;
        margin-top: 5px;
        margin-bottom: 0;
        text-align: center;
    }
    #div_link.error label, #div_verify.error label{
        color: #ff399e;
        display: block;
        animation: fadein 0.5s;
    }
    @keyframes fadein {
        from { max-height: 0; }
        to   { max-height: 50px; }
    }
    @keyframes fadeout {
        from { max-height: 50; }
        to   { max-height: 0; }
    }
    #tweet_content, #tweet_content iframe{
        transition-duration: 0.5s;
        transition-property: all;
        animation: fadeIn ease 0.5s;
    }

    .user_avatar{
        width: 25px;
        height: 25px;
        border-radius: 50%;
        margin-right: 10px;
    }
    .tbl_drawing td{
        padding: 5px 20px 2px 0px;
        width: auto;
        text-align: left;
    }
    </style>
<style>
.circle {
  padding: 13px 20px;
  border-radius: 50%;
  background-color: #ED8D8D;
  color: #fff;
  max-height: 50px;
  z-index: 2;
}

.how-it-works.row .col-2 {
  align-self: stretch;
}
.how-it-works.row .col-2::after {
  content: "";
  position: absolute;
  border-left: 3px solid #ED8D8D;
  z-index: 1;
}
.how-it-works.row .col-2.bottom::after {
  height: 50%;
  left: 50%;
  top: 50%;
}

.how-it-works.row .col-2.full::after {
  height: 100%;
  left: calc(50% - 3px);
}
.how-it-works.row .col-2.full:nth-child(odd)::after{
  left: 50%;
}
.how-it-works.row .col-2.top::after {
  height: 50%;
  left: 50%;
  top: 0;
}
.how-it-works.row .col-2.top:last-child:after {
    left: calc(50% - 3px);
}

#div_timeline .row.timeline:before{
    content: none;
}

.timeline{
    padding: 0!important;
    margin-right: -15px!important;
    margin-left: -15px!important;
}
.timeline div {
  padding: 0;
  height: 40px;
}
.timeline hr {
  border-top: 3px solid #ED8D8D;
  margin: 0;
  top: 17px;
  position: relative;
}
.timeline .col-2 {
  display: flex;
  overflow: hidden;
}

.timeline .corner {
  border: 3px solid #ED8D8D;
  width: 100%;
  position: relative;
  border-radius: 15px;
}
.timeline .top-right {
  left: 50%;
  top: -50%;
}
.timeline .left-bottom {
  left: -50%;
  top: calc(50% - 3px);
}
.timeline .top-left {
  left: -50%;
  top: -50%;
}
.timeline .right-bottom {
  left: 50%;
  top: calc(50% - 3px);
}

.col-8.text-right{
    text-align: -webkit-right!important;
}

    </style>
{% endblock %}

{% block content %}


    <div class="container-fluid">
                <div class="card">
                    <div class="card-body">
                        <div class="row px-md-5 px-sm-2">
                            <div class="col-sm-12 mt-5 text-center">
                                <h2>RETWEET PICKER <span style="color:yellow">BETA</span></h2>
                                <span class="text-secondary">Retweet picker is currently in beta mode and is currently <u>limited to retweet competitions no longer than 7 days</u>. If you run into an issue please email business@gridgaming.io so we can make it better. Beta currently only works with text only tweets. Next release will work with images and URLs</span>
                                <hr>
                                <h6 style="text-align: center;">Type or paste Twitter link</h6>
                                <div class='row'>
                                    <div class='col-sm-12 my-2 px-sm-5' id="div_link">
                                        <input type="text" class="form-control" placeholder="https://twitter.com/ ... /status/ ..." id="in_link">
                                        <label>Please fill this link field!</label>
                                    </div>
                                    
                                    <div class='col-sm-12 mt-2 text-center' >
                                        <button class="btn btn-primary mx-2 my-2 px-5" disabled id="btn_fetching" style="display: none;">
                                            <span class="spinner-border spinner-border-sm"></span>
                                             Fetching data ...
                                        </button>
                                        <button class='btn  btn-primary mx-2 my-2 px-5' id="btn_draw">DRAW WINNER</button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-12 mt-5">
                                <h2 class="text-center">DRAW VERIFY</h2>
                                <div class='row'>
                                    <div class='col-sm-12 my-2 px-sm-5' id="div_verify">
                                        <input type="text" class="form-control" placeholder="Enter the draw ID or tweet url" id="in_drawid" value="wgirtuma6hkab3vk5np5">
                                        <label>Please input draw Id or tweet url to verify</label>
                                    </div>
                                    <div class='col-sm-12 mt-2 text-center'>
                                        <button class='btn  btn-success px-5' id="btn_verify">VERIFY</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
    </div>

    <div class="modal fade" id="myModal">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title" id="label_title">Import contest</h4>
                    <!-- <button type="button" class="close" data-dismiss="modal">&times;</button> -->
                </div>
                <div class="modal-body">
                    <h6 id="label_status">Content preview</h6>
                    <div id="tweet_content">

                    </div>
                    <h6 class="mt-3 px-3" id="label_retweetcount" style="color: white"></h6>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal" id="btn_close">Cancel</button>
                    <button type="button" class="btn btn-primary" id="btn_import">Import contest</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="verifyModal">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title" id="label_title">Draw Verify</h4>
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                </div>
                <div class="modal-body">
                    <h6  id="label_verifystatus">Drawed Result : </h6>
                    <h6  id="label_entries">Entries : <span id="spn_entries">_</span></h6>
                    <h6  id="label_drawdate">Draw date : <span id="spn_drawdate">_</span></h6>
                                        
                    <div class="">
                        <div class="container">
                            <h2 class="pb-3 pt-2 border-bottom mb-5">Drawing Timeline</h2>
                            <div id="div_timeline">
                                <!-- <div id="first_section">
                                    <div class="row align-items-center how-it-works d-flex">
                                        <div class="col-2 text-center top d-inline-flex justify-content-center align-items-center">
                                        <div class="circle font-weight-bold">1</div>
                                        </div>
                                        <div class="col-8">
                                            aaaa
                                        </div>
                                    </div>
                                </div>
                                <div id="between12">
                                    <div class="row timeline">
                                        <div class="col-2">
                                        <div class="corner top-right"></div>
                                        </div>
                                        <div class="col-8">
                                        <hr/>
                                        </div>
                                        <div class="col-2">
                                        <div class="corner left-bottom"></div>
                                        </div>
                                    </div>
                                </div>
                                <div id="second_section">
                                    <div class="row align-items-center justify-content-end how-it-works d-flex">
                                        <div class="col-8 text-right">
                                        sddddd
                                        </div>
                                        <div class="col-2 text-center full d-inline-flex justify-content-center align-items-center">
                                        <div class="circle font-weight-bold">2</div>
                                        </div>
                                    </div>
                                </div>
                                <div id="between23">
                                    <div class="row timeline">
                                        <div class="col-2">
                                        <div class="corner right-bottom"></div>
                                        </div>
                                        <div class="col-8">
                                        <hr/>
                                        </div>
                                        <div class="col-2">
                                        <div class="corner top-left"></div>
                                        </div>
                                    </div>
                                </div> -->
                            </div>
                        </div>
                    </div>
                    
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal" id="btn_close">Close</button>
                </div>
            </div>
        </div>
    </div>
    <div style="display: none;">
        <div id="first_section">
            <div class="row align-items-center how-it-works d-flex">
                <div class="col-2 text-center {2} d-inline-flex justify-content-center align-items-center">
                <div class="circle font-weight-bold">{0}</div>
                </div>
                <div class="col-8">
                    {1}
                </div>
            </div>
        </div>
        <!--path between 1-2-->
        <div id="between12">
            <div class="row timeline">
                <div class="col-2">
                <div class="corner top-right"></div>
                </div>
                <div class="col-8">
                <hr/>
                </div>
                <div class="col-2">
                <div class="corner left-bottom"></div>
                </div>
            </div>
        </div>
        <!--second section-->
        <div id="second_section">
            <div class="row align-items-center justify-content-end how-it-works d-flex">
                <div class="col-8 text-right">
                {1}
                </div>
                <div class="col-2 text-center {2} d-inline-flex justify-content-center align-items-center">
                <div class="circle font-weight-bold">{0}</div>
                </div>
            </div>
        </div>
        <!--path between 2-3-->
        <div id="between23">
            <div class="row timeline">
                <div class="col-2">
                <div class="corner right-bottom"></div>
                </div>
                <div class="col-8">
                <hr/>
                </div>
                <div class="col-2">
                <div class="corner top-left"></div>
                </div>
            </div>
        </div>
    </div>
    <div id="tbl_drawing" style="display: none;">
        <table class="tbl_drawing">
            <tbody></tbody>
        </table>
    </div>

{% endblock %}
{% block extra_scripts %}
    <!-- <script src="https://code.jquery.com/jquery-3.1.1.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script> -->
<!-- <script src="http://code.jquery.com/ui/1.12.1/jquery-ui.min.js" integrity="sha256-VazP97ZCwtekAsvgPBSUwPFKdrwD3unUfSGVYrahUqU=" crossorigin="anonymous"></script> -->
<script src="{% static 'taginput/jquery.tagsinput-revisited.js' %}"></script>
<script sync src="https://platform.twitter.com/widgets.js"></script>
<script  type="text/javascript">
    var link = "";
    var tweet_url = "";
    var draw_url = "";
    String.prototype.format = function () {
        var a = this;
        for (var k in arguments) {
            a = a.replace(new RegExp("\\{" + k + "\\}", 'g'), arguments[k]);
        }
        return a
    }

    $(function(){
        $("#div_link input").change(function(){
            $("#div_link").removeClass('error')
        })
        $("#div_verify input").change(function(){
            $("#div_verify").removeClass('error')
        })
        $("#btn_import").click(function(){
            $.ajax({
                type: "POST",
                url: "../import_contest",
                data: {'link': tweet_url},
                success: function (data) {
                    console.log(data);
                    if (data.success == true) {
                        location.href = "../" + data.gwid + "/entries"
                    } else {
                    }
                }
            })
        })
        $("#btn_draw").click(function(){
            link = $("#in_link").val().trim();
            valid = true
            if(link == "" || link.indexOf('https://twitter.com/') == -1){
                $("#div_link label").html('Please fill this link field!')
                $("#div_link").addClass('error')
                valid = false
            }
            if(valid == false){
                return
            }
            $("#btn_draw").hide()
            $("#btn_fetching").show()
            $.ajax({
                type: "POST",
                url: "../fetch_data",
                data: {'link': link},
                success: function (data) {
                    $("#btn_fetching").hide()
                    $("#btn_draw").show()
                    $("#tweet_content").html("")

                    var tweet = document.getElementById("tweet_content");
                    console.log(data);
                    if (data.success == true) {
                        tweet_url = data.tweet_url;
                        twttr.widgets.createTweet(
                            data.tweet_id, tweet,
                            {
                                conversation : 'none',    // or all
                                cards        : 'hidden',  // or visible
                                linkColor    : '#cc0000', // default is blue
                                theme        : 'light'    // or dark
                            })
                            .then (function (el) {
                                el.contentDocument.querySelector(".footer").style.display = "none";
                        });
                        $("#label_retweetcount").html("You can load entries up to " + data.free_max + " as free.  If you are sure, please click below button.")
                        $("#myModal").modal({backdrop: 'static', keyboard: false})
                    } else {
                        $("#div_link label").html(data.msg)
                        $("#div_link").addClass('error')
                        // setTimeout(function () { $("#myModal").modal("hide"); }, 500);
                        // swal.fire(
                        //     'Failed',
                        //     data.msg,
                        //     'error'
                        // )
                    }
                }
            })
        })

        $("#btn_verify").click(function(){
            draw_id = $("#in_drawid").val().trim()
            if(draw_id == ''){
                $("#div_verify").addClass('error');
                return;
            }
            $("#label_verifystatus").html("Please wait while getting data...")
            $("#spn_drawdate").html("_")
            $("#spn_entries").html("_")
            $("#label_drawdate").show()
            $("#label_entries").show()
            // $("#tbl_drawing tbody").html("")
            $("#verifyModal").modal({backdrop: 'static', keyboard: false})
            $.ajax({
                type: "POST",
                url: "/contests/draw_verify",
                data: {'draw_id': draw_id},
                success: function (data) {
                    if (data.success == true) {
                        if(data.draw_info.draw_status != 'W'){
                            $("#label_verifystatus").html("This contest is not finished yet.")
                            $("#label_drawdate").hide()
                            $("#label_entries").hide()
                        }else{
                            $("#label_verifystatus").html("Drawed Results :")
                            f_drawdate = new Date(data.draw_info.drawed_at).toLocaleString()
                            $("#spn_drawdate").html(f_drawdate)
                            $("#spn_entries").html(data.draw_info.entries)
                            show_rerolls(data.draw_info.winner_count, data.draw_info.rerolls);
                        }
                    } else {
                        $("#label_verifystatus").html(data.msg)
                        $("#label_drawdate").hide()
                        $("#label_entries").hide()
                    }
                }
            })
        })
    })
    function show_rerolls(wcount, data){
        $("#div_timeline").html("");
        console.log(data);
        index = 0;
        tbl_index = 1;
        str = "<tbody>";
        found_winner = 0
        winners = []
        while(1){
            if(index >= data.length){
                break;
            }
            r = data[index]
            reason = "";
            if(r.kind == 0){
                reason = r.reason;
            }else if(r.kind > 1){
                reason = "Choosen as winner!";
                found_winner += 1;
                winners.push(r);
            }
            str += "<tr id='rtr_" + tbl_index + "_" + r.id + "'><td><img class='user_avatar' src='" + r.user_info.profile_img + "'>"
            str += r.user_info.screen_name + "</td><td id='rtd_" + tbl_index + "_" + r.id + "'>" + reason +"</td></tr>";
                
            if(found_winner == wcount){
                str += '</tbody>'
                tbl_str = $("#tbl_drawing").html()
                tbl_str = tbl_str.replace('<tbody></tbody>', str)
                if(tbl_index % 2 == 1){
                    section_str = $("#first_section").html()
                    bet_str = $("#between12").html()
                }else{
                    section_str = $("#second_section").html()
                    bet_str = $("#between23").html()
                }
                if(tbl_index == 1){
                    before_class = 'bottom'
                }else{
                    before_class = 'full'
                }
                if(index == data.length - 1){
                    before_class = 'top'
                    bet_str = "";
                }
                section_str = section_str.format(tbl_index, tbl_str, before_class);
                $("#div_timeline").append(section_str + bet_str);
                str = "<tbody>";
                for(let i=index + 1;i<data.length;i++){
                    if(data[i].kind > 1){
                        for(let j=0; j<winners.length; j++){
                            if(winners[j].reason == data[i].id){
                                $("#rtd_" + tbl_index + "_" + winners[j].id).html("Rerolled");
                                winners.splice(j, 1);
                                found_winner -= 1;
                                break;
                            }
                        }
                        tbl_index += 1;
                        for(let j=0; j<winners.length; j++){
                            str += "<tr id='rtr_" + tbl_index + "_" + winners[j].id + "'><td><img class='user_avatar' src='" + winners[j].user_info.profile_img + "'>"
                            str += winners[j].user_info.screen_name + "</td><td id='rtd_" + tbl_index + "_" + winners[j].id + "'>" + "Chooen as winner!" +"</td></tr>";
                        }
                        break;
                    }
                }
                
            }
            index += 1
            console.log(index);
        }
        
    }
</script>
{% endblock extra_scripts %}