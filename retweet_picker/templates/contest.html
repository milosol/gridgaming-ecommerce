{% extends 'core/base.html' %} 
{% load static %} 
{% load mathfilters %} 
{% load humanize %}
{% block extra_head_tags %}

<link href="{% static 'taginput/jquery.tagsinput-revisited.css' %}" rel="stylesheet" />
<link href="https://cdn.datatables.net/1.10.21/css/jquery.dataTables.min.css" rel="stylesheet" />
<link href="https://cdn.datatables.net/buttons/1.6.2/css/buttons.dataTables.min.css" rel="stylesheet" />
<link href="{% static 'stepper/css/mdb.min.css' %}" rel="stylesheet" />

<script src="https://kit.fontawesome.com/a076d05399.js"></script>

<style>
    table.dataTable tbody tr {
        background: none !important;
    }

    table.dataTable th,
    table.dataTable tbody tr td {
        text-align: center;
    }

    table.dataTable th:nth-child(3),
    table.dataTable tbody tr td:nth-child(3) {
        text-align: left;
    }

    #zero_config_filter label,
    .paginate_button,
    .dataTables_info {
        color: #b2b9bf !important;
    }

    #zero_config_filter label input {
        border-style: none !important;
        background-color: #b7c5e2  !important;
    }

    .dt-button {
        background: none !important;
        background-color: #323743 !important;
        color: #b2b9bf !important;
    }

    .dataTables_wrapper .dataTables_paginate .paginate_button {
        box-sizing: border-box;
        display: inline-block;
        min-width: 1.5em;
        padding: 0.5em 1em;
        margin-left: 2px;
        text-align: center;
        text-decoration: none !important;
        cursor: pointer;
        *cursor: hand;
        color: white !important;
        border: 1px solid transparent;
        border-radius: 2px;
    }

    .dataTables_wrapper .dataTables_length,
    .dataTables_wrapper .dataTables_filter,
    .dataTables_wrapper .dataTables_info,
    .dataTables_wrapper .dataTables_processing,
    .dataTables_wrapper .dataTables_paginate {
        color: white;
    }

    .draw_container .card {
        background-color: #1e3564;
        box-shadow: 2px 2px 5px #a2a2a2;
        border-radius: 7px;
    }

    .draw_container .card-header {
        background-color: rgba(0, 0, 0, 0.1);
    }

    #div_chkactions.warning {
        animation-name: warning;
        animation-duration: 0.5s;
    }

    #btn_toactions.warning,
    #btn_todraw.warning,
    #btn_draw {
        /* animation: next-warning 1s infinite; */
        /* animation-duration: 3s; */
        background: #00acc1;
        border: none;
        border-radius: 25px;
        color: snow;
        cursor: pointer;
        font-size: 1em;
        letter-spacing: 0.1em;
        outline: none;
        padding: 0.5em 2em;
        position: relative;
        /* text-transform: uppercase; */
        z-index: 1;
    }

    #btn_toactions.warning::before,
    #btn_todraw.warning::before,
    #btn_draw::before {
        background: #007ac1;
        border-radius: inherit;
        content: "" !important;
        filter: blur(10px);
        opacity: 0.75;
        position: absolute;
        transition: all 0.3s ease-in-out;
        width: 100%;
        height: 100%;
        top: 0;
        right: 0;
        z-index: -1;
    }

    #btn_toactions.warning:hover::before,
    #btn_todraw.warning:hover::before,
    #btn_draw:hover::before {
        filter: blur(20px);
        opacity: 1;
    }

    @keyframes warning {
        0% {
            background-color: #691ed4;
        }

        25% {
            background-color: #272b34;
        }

        50% {
            background-color: #691ed4;
        }

        100% {
            background-color: #272b34;
        }
    }

    @keyframes next-warning {
        0% {
            background-color: #691ed4;
            border-color: #691ed4;
        }

        50% {
            background-color: #21c1d6;
            border-color: #21c1d6;
        }

        100% {
            background-color: #691ed4;
            border-color: #691ed4;
        }
    }

    .user_avatar {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        margin-right: 10px;
    }

    #tbl_drawing tr td:nth-child(1){
        padding: 20px 0px 2px 0px;
        width: 45%;
        text-align: left;
    }
    #tbl_drawing tr td:nth-child(2){
        padding: 20px 5px 2px 15px;
        width: 45%;
        text-align: left;
    }
    #tbl_drawing tr td:nth-child(3){
        padding: 20px 0px 2px 15px;
        width: 10%;
        text-align: left;
    }

    .td-reroll .rtdr-disabled {
        color: gray;
    }

    .status_id {
        padding: 3px;
    }

    #spn_status {
        font-weight: bold;
        color: #7460ee;
    }

    .entries_id {
    }

    #spn_entries {
        font-weight: bold;
    }

    .winners_id {
        padding: 3px;
    }

    .draw_date_id {
        padding: 3px;
    }

    #spn_drawdate {
        font-weight: bold;
    }

    .draw_id {
        padding: 3px;
    }

    #spn_drawid {
        font-weight: bold;
        color: #7460ee;
    }
</style>
{% endblock %} 
{% block content %}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <ul class="nav nav-tabs md-tabs nav-justified primary-color px-2 mb-n4" role="tablist" style="font-size:1.2rem;">
                        <li class="nav-item">
                            <a class="nav-link active" data-toggle="tab" href="#download-just" role="tab">
                                <i class="fas fa-download pr-2"></i>Download Retweets</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-toggle="tab" href="#draw-just" role="tab">
                                <i class="fas fa-dice pr-2"></i>Choose Winner</a>
                        </li>
                    </ul>
                    <div class="tab-content card pt-sm-5 pt-md-4" id="myTabContentJust">
                        <div class="tab-pane fade show active" id="download-just" role="tabpanel" aria-labelledby="home-tab-just">
                            <div class="px-md-2 py-md-5 px-1 py-3">
                                <div class="row">
                                    <div class="col-md-12 text-center">
                                        <h6 class="text-center py-2 mx-auto px-5" style="border: 1px solid #90caf94d;color: #90caf9ba;border-radius: 20px; width:fit-content; max-width: 100%;">
                                            {{tweet_url}}
                                        </h6>
                                    </div>
                                    <div class="col-sm-5 col-md-5 mt-3 mb-2 py-2 px-3 text-center">
                                        <div class="card text-white mb-3 px-3 pt-3 pb-2 rounded-lg" style="
                        border: 1px solid #24332a;
                        box-shadow: 2px 2px 5px #21222d;
                      ">
                                            <h6 style="width: fit-content" id="h_retcount">
                                                Retweets count of tweet: {{ret_count}}
                                            </h6>
                                            <h6 style="width: fit-content" id="h_freeamount">
                                                Free amount : {{drawprice_free_max}}
                                            </h6>
                                            <h6 style="width: fit-content" id="h_paid">
                                                Paid amount : {{paid_amount}}
                                            </h6>
                                            <h6 style="width: fit-content" id="h_lefttimes">
                                                Free times left : 0 this month
                                            </h6>
                                            <h6 style="width: fit-content" id="h_membership">
                                                You are free from membership
                                            </h6>
                                            <h6 style="width: fit-content" id="h_pay">
                                                You should pay
                                                {% if user.user_profile.credit_display %}
                                                <img src="{% static 'assets/images/coin-xs.png' %}" style="padding-top:4px;width: 12px; vertical-align: text-top;">{{drawprice_price|mul:cc_per_usd|intcomma}}
                                                {% else %}
                                                ${{drawprice_price|intcomma}} ( = <img src="{% static 'assets/images/coin-xs.png' %}" style="padding-top:4px;width: 12px; vertical-align: text-top;">{{drawprice_price|mul:cc_per_usd|intcomma}})
                                                {% endif %}
                                                per more
                                                {{drawprice_per_amount}} retweets
                                            </h6>
                                            <button id="btn_pay" class="btn btn-outline-success mt-3 mb-3 py-2 font-18"
                                                disabled>
                                                Free
                                            </button>
                                            <h3 id="h_or">Or</h3>
                                            <a href="/profile?tab=membership" id="btn_upgrade" class="btn btn-outline-primary mt-2 mb-3 py-2 font-18">
                                                Upgrade Membership
                                            </a>
                                        </div>
                                    </div>
                                    <div class="col-sm-7 col-md-7 mt-3 mb-2 py-2 px-3 text-center">
                                        <h5 class="mt-3" style="line-height: normal" id="h_loadentry">
                                            You are free to download retweets. Click below button to
                                            start download.
                                        </h5>
                                        <button class="btn btn-success mt-3" id="btn_loadentry">
                                            Download retweets
                                        </button>
                                        <button class="mt-2 warning" id="btn_toactions" style="display: none">
                                            Choose Winner
                                            <i class="fas fa-arrow-circle-right"
                                                style="vertical-align: bottom; font-size: 20px"></i>
                                        </button>
                                        <h5 class="mt-5 text-danger" id="h_loadresult" style="display: none">
                                            No retweets found
                                        </h5>
                                        <div class="mt-4" id="progress" style="display: none">
                                            <h6>Loading retweets...</h6>
                                            <div class="progress" style="height: 10px" id="div_progress">
                                                <div class="progress-bar progress-bar-striped progress-bar-animated"
                                                    role="progressbar" aria-valuenow="0" aria-valuemin="0"
                                                    aria-valuemax="100" style="width: 0"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div id="div_zero" class="table-responsive" style="padding: 25px 10px 25px 10px;
                                                                    border: 1px solid #959ba982;
                                                                    box-shadow: 0px 0px 5px #4285f4ad;
                                                                    border-radius: 5px;">
                                    <div id="zero_config_wrapper"
                                        class="dataTables_wrapper container-fluid dt-bootstrap4 no-footer">
                                        <div class="row" style="margin-left: 0; margin-right: 0">
                                            <div class="col-sm-12">
                                                <table class="table product-overview dataTable no-footer"
                                                    id="zero_config" role="grid" aria-describedby="zero_config_info">
                                                    <thead>
                                                        <tr role="row">
                                                            <th tabindex="0" aria-controls="zero_config" rowspan="1"
                                                                colspan="1"
                                                                aria-label="Order ID: activate to sort column ascending"
                                                                style="width: 0px">
                                                                #
                                                            </th>
                                                            <th tabindex="0" aria-controls="zero_config" rowspan="1"
                                                                colspan="1"
                                                                aria-label="Order ID: activate to sort column ascending"
                                                                style="width: 0px">
                                                                source
                                                            </th>
                                                            <th tabindex="0" aria-controls="zero_config" rowspan="1"
                                                                colspan="1"
                                                                aria-label="Order ID: activate to sort column ascending"
                                                                style="width: 0px">
                                                                contestants
                                                            </th>
                                                            <th tabindex="0" aria-controls="zero_config" rowspan="1"
                                                                colspan="1"
                                                                aria-label="Product: activate to sort column ascending"
                                                                style="width: 0px">
                                                                created at
                                                            </th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="participants_tbody">
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="draw-just" role="tabpanel" aria-labelledby="profile-tab-just">
                            <div class="px-md-5 py-md-5 px-1 py-3 draw_container">
                                
                                <div class="row">
                                    <div class="col-md-12 text-center mb-4">
                                        <h6 class="text-center py-2 mx-auto px-5" style="border: 1px solid #90caf94d;color: #90caf9ba;border-radius: 20px; width:fit-content; max-width: 100%;">
                                            {{tweet_url}}
                                        </h6>
                                    </div>
                                    <div class="col-md-5 mt-2 px-md-4">
                                        <div class="card border-primary">
                                            <div class="card-header bg-primary">
                                                <h4 class="mb-0 text-white">DRAW DETAIL</h4>
                                            </div>
                                            <div class="card-body">
                                                <h6><span class="entries_id">Retweets Count : <span id="spn_entries" class="pl-2">_</span></span></h6>
                                                <h6>Number of winners : <span id="spn_winner" class="pl-2">_</span></h6>
                                                <h6>Check Bot : <span id="spn_botchk" class="pl-2"><i
                                                    class="fas fa-check text-success"></i></span></h6>
                                                <h6>Follow Main Account : <span id="spn_followenable" class="pl-2"><i
                                                            class="fas fa-check text-success"></i></span></h6>
                                                <h6>Follow Others : <span id="spn_followers" class="pl-2">_</span></h6>

                                                <h6><span class="draw_date_id mt-3">Draw Date : <span
                                                            id="spn_drawdate" class="pl-2">_</span></span></h6>
                                                <h6><span class="draw_id">Draw ID : <span
                                                            id="spn_drawid" class="pl-2">_</span></span></h6>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-7 mt-2 px-md-4">
                                        <div class="mt-5 text-center" id="div_choose">
                                            <h6 class="">
                                                Please click button to choose winner
                                            </h6>
                                            <button class="mt-3" id="btn_draw">
                                                Choose Winner
                                            </button>
                                        </div>
                                        <div class="card border-primary" id="div_drawing" style="display: none;">
                                            <div class="card-header bg-danger">
                                                <h4 class="mb-0 text-white">DRAWING BOARD</h4>
                                            </div>
                                            <div class="card-body">
                                                <h5 id="label_status">Please wait while choosing winner...</h5>
                                                <h5 id="label_reroll" class="text-right" style="display: none;">Reroll times left : <span id="spn_reroll">0</span></h5>
                                                <table id="tbl_drawing" class="mt-3">
                                                    <tbody>
                                                    </tbody>
                                                </table>
                                                <div class="text-center mt-3">
                                                    <button type="button" class="btn btn-secondary" id="btn_drawstop">Stop drawing</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- 
<div class="modal fade" id="myModal">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="label_title">Draw winner</h4>
            </div>
            <div class="modal-body">
                <h6 id="label_status">Please wait while choosing winner...</h6>
                <table id="tbl_drawing" class="mt-3">
                    <tbody></tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="btn_drawstop">
                    Stop drawing
                </button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal" id="btn_close">
                    Close
                </button>
            </div>
        </div>
    </div>
</div> -->
<form action="" method="post" id="form_pay" hidden>
    {% csrf_token %}
    <input type="hidden" name="amount" value="0" />
    <input type="hidden" name="gwid" value="0" />
</form>

{% endblock %} 
{% block extra_scripts %}

<script src="{% static 'stepper/js/mdb.min.js' %}"></script>

<script src="https://cdn.datatables.net/1.10.21/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/buttons/1.6.2/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/1.6.2/js/buttons.flash.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
<script src="https://cdn.datatables.net/buttons/1.6.2/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/1.6.2/js/buttons.print.min.js"></script>

<script type="text/javascript">
    var context =  JSON.parse("{{context|escapejs}}");
    var progress_handle = 0;
    var entry_table = 0;
    var start_from = 100
    var drawing_handle = 0;
    var credit_display = '{{user.user_profile.credit_display}}';
    var cc_per_usd = {{cc_per_usd}};
    function initialize() {
        init_entrypanel()
        init_drawpanel()
    }

    function init_entrypanel() {
        if (context.draw_status == 'C' || context.draw_status == 'E') {
            $("a[href='#draw-just']").parent().hide()
            if(context.pay_status < 5){
                $("#h_freeamount").show()  // free 
                $("#h_paid").hide()
                $("#h_pay").hide()
                $("#h_membership").hide()
                $("#h_lefttimes").hide()
                $("#btn_pay").prop('disabled', true);
                $("#btn_pay").html("Free")
                $("#h_or").hide();
                $("#btn_upgrade").hide();
                $("#h_loadentry").html("You can download all retweets now. Click below button to start download.")
                if (context.pay_status == 1){  // paid
                    $("#btn_pay").html("You already paid")
                    $("#h_paid").show()
                }else if(context.pay_status == 2){ // unlimited
                    $("#h_membership").html("You are free from membership")
                    $("#h_membership").show()
                    $("#h_lefttimes").html("Free times left : unlimited")
                    $("#h_lefttimes").show()
                }else if(context.pay_status == 3){ // free from bonus
                    $("#h_membership").html("You've got free times from launching giveaway")
                    $("#h_membership").show()
                    $("#h_lefttimes").html("Free times left : " + context.left_times)
                    $("#h_lefttimes").show()
                }else if(context.pay_status == 4){ // free from limited membership
                    $("#h_membership").html("You are free from membership")
                    $("#h_membership").show()
                    $("#h_lefttimes").html("Free times left : " + context.left_times + " / " + context.total_times + " this month");
                    $("#h_lefttimes").show()
                }
            }else{
                $("#h_paid").show() // you must pay
                $("#h_pay").show()
                $("#h_lefttimes").hide()
                $("#h_membership").hide()
                if(credit_display == 'True'){
                    str = "Pay " + context.pay_price * cc_per_usd + " credits"
                }else{
                    str = "Pay $" + context.pay_price;
                }
                $("#btn_pay").html(str)
                $("#btn_pay").prop('disabled', false);
                $("#h_or").show();
                $("#btn_upgrade").show();
                $("#h_loadentry").html("You can download only " + (context.paid_amount + context.drawprice_free_max) + " retweets");
                if (context.pay_status == 5) { // over limit
                    $("#h_lefttimes").html("Free times left : " + context.left_times + " / " + context.total_times + " this month");
                    $("#h_lefttimes").show()
                    $("#h_membership").show()
                    $("#h_membership").html("You used all free times this month.")
                }
            }
            $('#div_zero').hide()
            $('#btn_toactions').hide()
        } else {
            $("a[href='#draw-just']").parent().show()
            $('#btn_toactions').show()
            $("#h_retcount").html("You have downloaded " + context.loaded_count + " retweets.")
            $("#h_freeamount").hide()
            $("#h_paid").hide()
            $("#h_lefttimes").hide()
            $("#h_membership").hide()
            $("#h_pay").hide()
            $("#btn_pay").hide()
            $("#h_or").hide()
            $("#btn_upgrade").hide()
            $("#h_loadentry").hide()
            $("#btn_loadentry").hide()
            $("#progress").hide()
            setTimeout(() => {
                load_all_entries();
            }, 2000);
        }
    }
    function init_drawpanel() {
        // draw_status, draw_winners, draw_date, draw_id
        setdrawdetail()
        $("#label_reroll").hide()
        if(context.draw_status == 'W'){
            $("#div_choose").hide();
            $("#div_drawing").fadeIn();
            $("#label_status").html("<i class=\"mr-2 mdi mdi-flag-checkered\"></i> Draw is finished")
            $("#label_status").attr('class', 'text-success');
            $("#btn_drawstop").hide()
            $("#label_reroll").show()
            console.log("context.reroll_limit:", context.draw_info.reroll_limit);
            $("#spn_reroll").html(context.draw_info.reroll_limit)
            show_rerolls(context.rerolls)
            show_reroll_buttons();
        }else if(context.draw_status == 'D'){
            $("#div_choose").hide();
            $("#div_drawing").fadeIn();
            $("#label_status").html("Please wait while choosing winner...")
            $("#label_status").attr('class', 'text-warning');
            $("#btn_drawstop").prop('disabled', false);
            $("#btn_drawstop").show()
            setTimeout(() => {
                drawing_handle = setInterval(() => {
                    get_drawing_progress()
                }, 1000);
            }, 2000);
        }
        
    }
    function setdrawdetail() {
        if (context.draw_status != 'C' && context.draw_status != 'E') {
            $("#spn_entries").html(context.loaded_count);
        }
        $("#spn_winner").html(context.winner_count);
        if(context.bot_chk){
            $("#spn_botchk").html('<i class="fas fa-check text-success"></i>');
        }else{
            $("#spn_botchk").html('<i class="fas fa-times text-danger"></i>');
        }
        str = context.followers.split(',').join(', ');
        if(str == ''){
            str = "_"
        }
        $("#spn_followers").html(str);
        if(context.draw_status == 'W'){
            $("#spn_drawdate").html(context.draw_info.drawed_at)
            $("#spn_drawid").html("<a href='/retweet-picker/draw-result/" + context.draw_info.draw_id + "'>" + context.draw_info.draw_id + "</a>")
        }else{
            $("#spn_drawdate").html('_')
            $("#spn_drawid").html('_')
        }
        
    }
    function get_winners_names(winners) {
        if (winners.length > 0) {
            str = ''
            for (i = 0; i < winners.length; i++) {
                if (i != 0) str += ', ';
                str += "<a href='https://www.twitter.com/" + winners[i].screen_name  +"' target='_blank'>" + winners[i].screen_name
            }
            return str
        } else {
            return '_'
        }
    }

    function draw_table(data) {
        if (!entry_table) {
            entry_table = $('#zero_config').DataTable({
                dom: 'Bfrtip',
                lengthMenu: [
                    [10, 25, 50, -1],
                    ['10 rows', '25 rows', '50 rows', 'Show all']
                ],
                ordering: false,
                buttons: [
                    'pageLength'
                ]
            });
        }
        var str = "";
        for (i = 0; i < data.length; i++) {
            str = "<img class='user_avatar' src='" + data[i].profile_img + "'>  " + data[i].screen_name
            entry_table.row.add([
                i + 1,
                "twitter",
                str,
                data[i].account_created.split('T')[0],
            ])
        }
        entry_table.draw();
        $("table.dataTable tbody tr").css("background-color", 'none');
    }
    function load_all_entries() {
        if (entry_table)
            entry_table.clear();
        $('#div_zero').show()
        $.ajax({
            type: "POST",
            url: "/retweet-picker/load_all_entries",
            data: { 'gwid': context.gwid },
            success: function (data) {
                if (data.success == true) {
                    draw_table(data.participants)
                } else {
                }
            }, error: function (e) {

            }
        })
    }

    
    
    function get_drawing_progress() {
        $.ajax({
            type: "POST",
            url: "/retweet-picker/drawing_progress",
            data: { 'gwid': context.gwid },
            success: function (data) {
                if (data.success == true) {
                    show_rerolls(data.rerolls);
                } else {
                }
            }
        })
    }

    function show_reroll_buttons() {
        items = $(".td-reroll").toArray();
        for (i = 0; i < items.length; i++) {
            td_id = $(items[i]).attr('id').split('_')[1]
            $(items[i]).html('<a href="javascript:void(0);" onclick="draw_reroll(' + td_id + ');"><i class="fas fa-redo" style="font-size:20px;"></i></a>')
        }
        if(context.draw_info.reroll_limit == 0){
            $(".td-reroll a").addClass('rtdr-disabled');
        }
    }
    function show_rerolls(data) {
        rids = []
        for (i = 0; i < data.length; i++) {
            r = data[i]
            if ($("#rtr_" + r.id).length == 0) {
                str = "<tr id='rtr_" + r.id + "'><td><img class='user_avatar' src='" + r.user_info.profile_img + "'>"
                str += "<a href='https://www.twitter.com/" +r.user_info.screen_name +"' target='_blank'>" + r.user_info.screen_name + "</td><td id='rtd_" + r.id + "'>Analyzing...</td><td id='rtdr_" + r.id + "'></td></tr>";
                $("#tbl_drawing tbody").append(str);
            }
            rids.push(r.id.toString());
            if (r.kind == 0) {
                $("#rtd_" + r.id).html(r.reason);
            } else if (r.kind == 2) {
                $("#rtd_" + r.id).html("Chosen as winner!");
                $("#rtdr_" + r.id).addClass("td-reroll");
            } else if (r.kind == 3) {
                $("#rtd_" + r.id).html("rerolled");
                $("#rtdr_" + r.id).html("");
                $("#rtdr_" + r.id).removeClass("td-reroll");
            }
        }
        rows = $("#tbl_drawing tbody tr").toArray();
        rows.forEach(function (row) {
            row_id = $(row).attr('id').split("_")[1];
            if (rids.indexOf(row_id) == -1) {
                $("#rtr_" + row_id).remove();
            }
        })
    }
    function load_entry_progress() {
        $.ajax({
            type: "POST",
            url: "/retweet-picker/load_entry_progress",
            data: { 'gwid': context.gwid },
            success: function (data) {
                if (data.success == true) {
                    if (data.load_status == 'C') {
                        $("#div_progress div").attr('aria-valuenow', data.progress);
                        $("#div_progress div").css('width', data.progress + '%');
                    } else if (data.load_status == 'L') {
                        $("#div_progress div").attr('aria-valuenow', 100);
                        $("#div_progress div").css('width', 100 + '%');
                        clearInterval(progress_handle);
                        context.draw_status = 'L';
                        context.loaded_count = data.loaded_count
                        setTimeout(() => {
                            initialize();
                        }, 2000);
                    } else if (data.load_status == 'E') {
                        $("#btn_loadentry").attr("disabled", false);
                        if (context.pay_status > 2)
                            $("#btn_pay").attr("disabled", false);
                        clearInterval(progress_handle);
                        $("#progress").hide()
                        $("#h_loadresult").html(data.load_error);
                        $("#h_loadresult").show();
                    }
                } else {

                }
            }
        })
    }
    function fnload_entry() {
        $("#h_loadresult").hide();
        $("#btn_pay").attr("disabled", true);
        $("#btn_loadentry").attr("disabled", true);
        $("#div_progress div").css('width', '0');
        $("#progress").show()

        if (entry_table)
            entry_table.clear().draw();
        $.ajax({
            type: "POST",
            url: "/retweet-picker/load_entries",
            data: { 'gwid': context.gwid, 'pay_status': context.pay_status },
            success: function (data) {
                if (data.success == true) {
                    progress_handle = setInterval(() => {
                        load_entry_progress()
                    }, 4000);
                } else {
                    $("#progress").hide()
                    $("#h_loadresult").html(data.msg);
                    $("#h_loadresult").show();
                }
            }, error: function (data) {
                $("#btn_pay").attr("disabled", false);
                $("#btn_loadentry").attr("disabled", false);
                clearInterval(progress_handle);
                $("#progress").hide()
                $("#h_loadresult").html("Error occurred in server.");
                $("#h_loadresult").show();
            }
        })
    }
    function draw_reroll(id) {
        bdisabled = $("#rtdr_" + id + " a").hasClass('rtdr-disabled');
        if (bdisabled == true) {
            return
        }
        
        draw_winner('reroll', id)
    }
    function draw_winner(type, id) {
        swal.fire({
            title: 'Are you sure?',
            icon: 'warning',
            text: "You will start drawing winner now.",
            showCancelButton: true,
            background: '#e9ecef',
            confirmButtonColor: '#21c1d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Yes, i am sure!'
        }).then((result) => {
            if (result.value) {
                $("#label_status").html("Please wait while choosing winner...")
                $("#label_status").attr('class', 'text-warning');
                $("#btn_drawstop").prop('disabled', false);
                $("#btn_drawstop").show()
                if (type == 'draw') {
                    $("#tbl_drawing tbody").html("")
                } else {
                    $(".td-reroll a").addClass('rtdr-disabled');
                    $("#rtdr_" + id + " a").html('<div class="spinner-border text-dark" role="status" style="width:22px;height:22px;"></div>')
                }
                $('#div_choose').hide();
                $("#div_drawing").fadeIn();
                setTimeout(() => {
                    drawing_handle = setInterval(() => {
                        get_drawing_progress()
                    }, 1000);
                }, 2000);
                context.draw_status = 'D'
                $.ajax({
                    type: "POST",
                    url: "../draw",
                    data: {
                        'gwid': context.gwid, 'draw_type': type, 'reroll_id': id
                    },
                    success: function (data) {
                        setTimeout(() => {
                            clearInterval(drawing_handle);
                            show_reroll_buttons();
                        }, 2000);
                        if (data.success == true) {
                            if (data.stop == true) {
                                context.draw_status = 'S'
                                $("#spn_drawdate").html('-')
                                $("#spn_drawid").html('-')
                                $("#label_status").html("<i class=\"mr-2 mdi mdi-stop-circle\"></i> Draw is stopped")
                                $("#label_status").attr('class', 'text-info');
                                $("label_reroll").hide()
                                setTimeout(() => {
                                    $("#div_drawing").fadeOut();
                                    $("#div_choose").fadeIn();
                                }, 2000);
                            } else {
                                context.draw_status = 'W'
                                $("#label_status").html("<i class=\"mr-2 mdi mdi-flag-checkered\"></i> Draw is finished")
                                $("#label_status").attr('class', 'text-success');
                                $("#label_reroll").show()
                                context.draw_info.reroll_limit = data.draw_info.reroll_limit
                                $("#spn_reroll").html(data.draw_info.reroll_limit)
                                $("#spn_drawdate").html(data.draw_info.drawed_at)
                                $("#spn_drawid").html("<a href='/retweet-picker/draw-result/" + data.draw_info.draw_id + "'>" + data.draw_info.draw_id + "</a>")
                            }
                            $("#btn_drawstop").hide()
                        } else {
                            if (type == 'draw') {
                                $('#div_drawing').hide();
                                $("#div_choose").fadeIn()
                            } else {
                                $(".td-reroll a").prop('disabled', false);
                                if('reroll_limit' in data){
                                    $("#label_reroll").show()
                                    $("#spn_reroll").html(data.reroll_limit)
                                    context.draw_info.reroll_limit = data.draw_info.reroll_limit
                                }
                            }
                            swal.fire(
                                'Failed',
                                data.msg,
                                'error'
                            )
                        }
                    }, error: function () {
                        if (drawing_handle)
                            clearInterval(drawing_handle);
                        if (type == 'draw') {
                            $('#div_drawing').hide();
                            $("#div_choose").fadeIn()
                        } else {
                            $(".td-reroll a").prop('disabled', false);
                        }
                        swal.fire(
                            'Failed',
                            "Failed on processing drawing winner. Please try again.",
                            'error'
                        )
                    }
                })
            } else if (result.dismiss === Swal.DismissReason.cancel) {

            }
        })
    }
    $(function () {
        initialize()
        if(context.tab == 'draw'){
            $("a[href='#draw-just']").trigger("click");
        }
        $("#btn_pay").click(function () {
            if (context.pay_status < 3 || context.pay_price == 0) return
            $("#form_pay input[name='amount']").val(context.pay_price);
            $("#form_pay input[name='gwid']").val(context.gwid);
            pay_credit = context.pay_price * cc_per_usd
            if(context.current_credit >= pay_credit){
                swal.fire({
                title: 'Are you sure?',
                icon: 'warning',
                text: "This will remove " + pay_credit + " credits from your account. Are you sure you want to continue?",
                showCancelButton: true,
                background: '#e9ecef',
                confirmButtonColor: '#21c1d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes, I am sure'
                }).then((result) => {
                    if (result.value) {
                        $("#form_pay").submit();
                    } else if (result.dismiss === Swal.DismissReason.cancel) {

                    }
                })
            }else{
                swal.fire({
                title: 'Are you sure?',
                icon: 'warning',
                text: (pay_credit-context.current_credit) + " more credits are required to pay. Are you going to buy more credits?",
                showCancelButton: true,
                background: '#e9ecef',
                confirmButtonColor: '#21c1d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes, buy more credits'
                }).then((result) => {
                    if (result.value) {
                        location.href="/wallet?need=" + (pay_credit - context.current_credit) + "&cart=draw_" + context.gwid
                    } else if (result.dismiss === Swal.DismissReason.cancel) {

                    }
                })
            }
        })
        $("#btn_loadentry").click(function () {
            if (context.pay_status > 2) {
                swal.fire({
                    title: 'Are you sure?',
                    icon: 'warning',
                    text: "Now you can download only " + (context.paid_amount + context.drawprice_free_max) + " retweets. \n To download all retweets you must pay.",
                    showCancelButton: true,
                    background: '#e9ecef',
                    confirmButtonColor: '#21c1d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Proceed without pay'
                }).then((result) => {
                    if (result.value) {
                        fnload_entry()
                    } else if (result.dismiss === Swal.DismissReason.cancel) {

                    }
                })
            } else {
                fnload_entry();
            }

        })
        $("#btn_toactions").click(function () {
            $("a[href='#draw-just']").trigger("click");
        })

        $("#btn_draw").click(function () {
            draw_winner('draw', 0)
        })
        $("#btn_drawstop").click(function () {
            swal.fire({
                title: 'Are you sure?',
                icon: 'warning',
                text: "This will stop drawing winner.",
                showCancelButton: true,
                background: '#e9ecef',
                confirmButtonColor: '#21c1d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes, i am sure!'
            }).then((result) => {
                if (result.value) {
                    $("#btn_drawstop").prop('disabled', true);
                    $.ajax({
                        type: "POST",
                        url: "../drawstop",
                        data: { 'gwid': context.gwid },
                        success: function (data) {
                            if (data.success == true) {
                                if(data.stoped == true){
                                    if(drawing_handle){
                                        clearInterval(drawing_handle);
                                    }
                                    $("#div_drawing").hide();
                                    $("#div_choose").fadeIn();
                                }
                                $("#label_status").html("Please wait while we stop drawing...")
                                $("#label_status").attr('class', 'text-warning');
                            } else {
                                $("#btn_drawstop").prop('disabled', false);
                                swal.fire(
                                    "Could not stop drawing,",
                                    data.msg,
                                    'error'
                                )
                            }
                        }
                    })
                } else if (result.dismiss === Swal.DismissReason.cancel) {

                }
            })
        })
    })
</script>
{% endblock extra_scripts %}